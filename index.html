<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Admin Portal - Live Stream Fixed</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #007bff; --dark: #121212; --panel: #1e1e1e; }
        body { margin: 0; background: var(--dark); color: white; font-family: sans-serif; overflow: hidden; }

        /* Auth Screen */
        .auth-container { position: fixed; inset: 0; background: var(--dark); z-index: 2000; display: flex; align-items: center; justify-content: center; }
        .auth-card { background: white; color: #333; padding: 30px; border-radius: 15px; width: 320px; text-align: center; }
        .auth-card input { width: 90%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; }
        .auth-card button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }

        /* Layout */
        header { height: 60px; background: #fff; color: #333; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .user-profile { display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: bold; color: var(--primary); }
        .user-avatar { width: 35px; height: 35px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

        .wrapper { display: flex; height: calc(100vh - 60px); }
        .content-area { flex: 1; padding: 30px; display: flex; flex-direction: column; align-items: center; overflow-y: auto; }
        .chat-sidebar { width: 320px; background: #f4f4f4; color: #333; display: flex; flex-direction: column; border-left: 1px solid #ddd; }

        /* Sidebar */
        .swipe-tab { position: fixed; right: -300px; top: 60px; width: 300px; height: 100%; background: var(--panel); transition: 0.3s; z-index: 500; border-left: 2px solid var(--primary); }
        .swipe-tab.active { right: 0; }
        .menu-item { padding: 15px 25px; border-bottom: 1px solid #333; cursor: pointer; color: #ccc; }
        .menu-item:hover { background: #252525; color: white; }

        .page { display: none; width: 100%; max-width: 850px; }
        .page.active { display: block; }
        .card { background: #222; padding: 25px; border-radius: 12px; border: 1px solid #333; }
        
        #shared-video { width: 100%; border-radius: 10px; background: #000; margin-top: 15px; border: 2px solid #444; min-height: 350px; object-fit: contain; }
        .share-btn { background: #28a745; color: white; padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .stop-btn { background: #dc3545; color: white; padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; display: none; }

        #chat-msgs { flex: 1; padding: 10px; overflow-y: auto; font-size: 14px; }
        .msg-bubble { background: white; padding: 8px; margin-bottom: 5px; border-radius: 5px; display: flex; justify-content: space-between; border: 1px solid #ddd; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="auth-screen" class="auth-container">
    <div class="auth-card">
        <h2 id="auth-title">Sign In</h2>
        <input type="text" id="user-id" placeholder="User ID / Name">
        <input type="password" id="user-pass" placeholder="Password">
        <div id="signup-fields" class="hidden"><input type="text" id="user-hint" placeholder="Security Hint"></div>
        <button onclick="handleAuth()" id="auth-btn">Login</button>
        <p onclick="toggleAuthMode()" id="toggle-text" style="cursor:pointer; color:#007bff; margin-top:10px;">Don't have an account? Sign Up</p>
    </div>
</div>

<div id="main-ui" class="hidden">
    <header>
        <div style="font-size: 20px; font-weight: bold;">LIVE PORTAL</div>
        <div class="user-profile" onclick="toggleSidebar()">
            <span id="display-name">User</span>
            <div class="user-avatar" id="avatar-icon">U</div>
        </div>
    </header>

    <div class="wrapper">
        <div class="content-area">
            <div id="page-video" class="page active">
                <div class="card" style="text-align:center;">
                    <h2 style="color:red;">üî¥ YouTube Player</h2>
                    <a id="play-btn" href="#" target="_blank" style="background:red; color:white; padding:15px 40px; border-radius:10px; text-decoration:none; font-weight:bold; display:inline-block;">WATCH YOUTUBE</a>
                    <div style="margin-top:20px;">
                        <input type="text" id="yt-url" style="width:60%; padding:12px; background:#333; color:white; border:none;" placeholder="YouTube Link...">
                        <button onclick="updateLink()" style="padding:12px; background:green; color:white; border:none;">Update</button>
                    </div>
                </div>
            </div>

            <div id="page-screenshare" class="page">
                <div class="card" style="text-align:center;">
                    <h2>üñ•Ô∏è Live Screen Sharing</h2>
                    <p id="share-status">Initializing connection...</p>
                    <button id="start-share" class="share-btn" onclick="startCapture()">Start Broadcast</button>
                    <button id="stop-share" class="stop-btn" onclick="stopCapture()">Stop Sharing</button>
                    <button id="watch-live" class="share-btn" style="display:none; background:#007bff;" onclick="joinStream()">Watch Live Now</button>
                    <video id="shared-video" autoplay playsinline></video>
                </div>
            </div>
            <div id="page-profile" class="page"><div class="card"><h2>üë§ Profile</h2><p>User: <span id="p-name"></span></p></div></div>
        </div>

        <div class="chat-sidebar">
            <div style="padding:15px; background:#eee; font-weight:bold;">Live Chat</div>
            <div id="chat-msgs"></div>
            <div style="padding:10px; display:flex; gap:5px; border-top:1px solid #ddd;">
                <input type="text" id="c-text" style="flex:1; padding:8px;" placeholder="Message...">
                <button onclick="sendMsg()" style="padding:8px; background:var(--primary); color:white; border:none; border-radius:5px;">Send</button>
            </div>
        </div>
    </div>
</div>

<div id="sidebar" class="swipe-tab">
    <div style="padding: 20px; font-weight: bold; background: #252525;">MENU</div>
    <div class="menu-item" onclick="showPage('page-profile')">Profile</div>
    <div class="menu-item" onclick="showPage('page-video')">Video</div>
    <div class="menu-item" onclick="showPage('page-screenshare')">Screen Sharing</div>
    <div class="menu-item" onclick="logout()" style="color:red; border-top:1px solid #333;">Logout</div>
</div>

<script>
    // Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyBRMHSwe81bAULkRMhmBK5sX-6F_aSI2YM",
        authDomain: "weblivestream-3d90a.firebaseapp.com",
        databaseURL: "https://weblivestream-3d90a-default-rtdb.firebaseio.com",
        projectId: "weblivestream-3d90a",
        appId: "1:731300036585:web:08e93ab2c71a7db98b5578"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // PeerJS Variables
    let peer = null;
    let localStream = null;
    const currentUser = localStorage.getItem('active_user');

    function initPeer() {
        // Use Username as Peer ID for easy connection
        peer = new Peer(currentUser);

        peer.on('open', id => {
            document.getElementById('share-status').innerText = "Status: Ready (" + id + ")";
        });

        // BROADCASTER SIDE: Automatically answer "calls" from viewers with the stream
        peer.on('call', call => {
            if (localStream) {
                console.log("Broadcasting to viewer...");
                call.answer(localStream);
            }
        });
    }

    // Syncing UI with Firebase
    db.ref('screen_share_status').on('value', s => {
        const data = s.val();
        const statusText = document.getElementById('share-status');
        const watchBtn = document.getElementById('watch-live');
        const startBtn = document.getElementById('start-share');

        if(data && data.user !== currentUser) {
            statusText.innerHTML = `<b style="color:#28a745;">üî¥ ${data.user} is Live!</b>`;
            watchBtn.style.display = 'inline-block';
            startBtn.style.display = 'none';
        } else if(!data) {
            statusText.innerText = "No one is sharing right now.";
            watchBtn.style.display = 'none';
            if(!localStream) startBtn.style.display = 'inline-block';
        }
    });

    async function startCapture() {
        try {
            localStream = await navigator.mediaDevices.getDisplayMedia({ video: { cursor: "always" }, audio: true });
            document.getElementById('shared-video').srcObject = localStream;
            
            // Mark as live in Firebase
            db.ref('screen_share_status').set({ user: currentUser });

            document.getElementById('start-share').style.display = 'none';
            document.getElementById('stop-share').style.display = 'inline-block';

            localStream.getVideoTracks()[0].onended = () => stopCapture();
        } catch (err) { alert("Sharing failed: " + err); }
    }

    function stopCapture() {
        if(localStream) localStream.getTracks().forEach(t => t.stop());
        localStream = null;
        document.getElementById('shared-video').srcObject = null;
        db.ref('screen_share_status').remove();
        document.getElementById('start-share').style.display = 'inline-block';
        document.getElementById('stop-share').style.display = 'none';
    }

    function joinStream() {
        db.ref('screen_share_status').once('value', s => {
            if(!s.val()) return alert("No stream found.");
            const hostId = s.val().user;
            
            // VIEWER SIDE: Call the host to get their stream
            const call = peer.call(hostId, null); 
            call.on('stream', remoteStream => {
                document.getElementById('shared-video').srcObject = remoteStream;
                document.getElementById('share-status').innerText = "Connected to " + hostId;
            });
        });
    }

    // --- Original Logic (Auth & Chat) ---
    let isSignUp = false;
    function toggleAuthMode() {
        isSignUp = !isSignUp;
        document.getElementById('auth-title').innerText = isSignUp ? "Sign Up" : "Sign In";
        document.getElementById('signup-fields').classList.toggle('hidden');
        document.getElementById('auth-btn').innerText = isSignUp ? "Register" : "Login";
    }

    function handleAuth() {
        const id = document.getElementById('user-id').value.trim();
        const pass = document.getElementById('user-pass').value;
        if(isSignUp) {
            db.ref('users/' + id).set({ password: pass, name: id }).then(() => { alert("Created!"); toggleAuthMode(); });
        } else {
            db.ref('users/' + id).once('value', s => {
                if(s.val() && s.val().password === pass) { localStorage.setItem('active_user', id); location.reload(); }
                else alert("Wrong credentials");
            });
        }
    }

    if(currentUser) {
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('main-ui').classList.remove('hidden');
        document.getElementById('display-name').innerText = currentUser;
        document.getElementById('p-name').innerText = currentUser;
        document.getElementById('avatar-icon').innerText = currentUser.charAt(0).toUpperCase();
        initPeer();
    }

    function logout() { localStorage.clear(); location.reload(); }
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }
    function showPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        toggleSidebar();
    }

    db.ref('live_vid').on('value', s => { document.getElementById('play-btn').href = "https://www.youtube.com/watch?v=" + (s.val() || 'dQw4w9WgXcQ'); });
    function updateLink() {
        const val = document.getElementById('yt-url').value;
        if(val) { db.ref('live_vid').set(val.includes('v=') ? val.split('v=')[1].split('&')[0] : val); document.getElementById('yt-url').value = ""; }
    }
    db.ref('live_chat').limitToLast(15).on('value', snap => {
        const box = document.getElementById('chat-msgs'); box.innerHTML = "";
        snap.forEach(c => { box.innerHTML += `<div class="msg-bubble"><span><b>${c.val().user}:</b> ${c.val().text}</span> <b onclick="deleteMsg('${c.key}')" style="cursor:pointer;color:red;">...</b></div>`; });
        box.scrollTop = box.scrollHeight;
    });
    function sendMsg() {
        const t = document.getElementById('c-text').value;
        if(t) { db.ref('live_chat').push({ text: t, user: currentUser }); document.getElementById('c-text').value = ""; }
    }
    function deleteMsg(k) { if(confirm("Delete?")) db.ref('live_chat/'+k).remove(); }
</script>
</body>
</html>
